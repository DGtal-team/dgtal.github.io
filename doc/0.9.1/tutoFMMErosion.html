<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>DGtal: Tutorial: Local morphological opening of a 3d volume by the Fast Marching Method</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">DGtal
   &#160;<span id="projectnumber">0.9.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Tutorial: Local morphological opening of a 3d volume by the Fast Marching Method </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#secttutoFMMErosion1">Goal of the tutorial</a></li>
<li class="level1"><a href="#secttutoFMMErosion2">Some steps</a><ul><li class="level2"><a href="#subsecttutoFMMErosion21">Reading a vol</a></li>
<li class="level2"><a href="#subsecttutoFMMErosion22">Tracking a surface</a></li>
<li class="level2"><a href="#subsecttutoFMMErosion23">Local erosion</a></li>
<li class="level2"><a href="#subsecttutoFMMErosion24">Writing a vol</a></li>
</ul>
</li>
<li class="level1"><a href="#secttutoFMMErosion3">Your challenge</a><ul><li class="level2"><a href="#subsecttutoFMMErosion31">Excercise</a></li>
<li class="level2"><a href="#subsecttutoFMMErosion32">Hints</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><dl class="section user"><dt>Author(s) of this documentation:</dt><dd>Tristan Roussillon</dd></dl>
<h1><a class="anchor" id="secttutoFMMErosion1"></a>
Goal of the tutorial</h1>
<p>In this tutorial, we will see how to use the <a class="el" href="classDGtal_1_1FMM.html" title="Aim: Fast Marching Method (FMM) for nd distance transforms. ">FMM</a> class in order to perform a basic processing on a 3d volume. The <a class="el" href="classDGtal_1_1FMM.html" title="Aim: Fast Marching Method (FMM) for nd distance transforms. ">FMM</a> class is part of the <a class="el" href="packageGeometry.html">Geometry package</a>. In the same time, we will learn how to read and write vol files (see <a class="el" href="packageIO.html">IO package</a>) and we will get familiar with digital surfaces (see <a class="el" href="packageTopology.html">Topology package</a>).</p>
<p>In order to smooth the digital surface of a 3d volume, we want to perform a mophological opening (i.e. an erosion followed by a dilation) with a circular structural element of small radius. Since the radius is small, we do not want to scan the whole image but we want to work only in narrow band around the digital surface. That is why, we think that using the <a class="el" href="classDGtal_1_1FMM.html" title="Aim: Fast Marching Method (FMM) for nd distance transforms. ">FMM</a> class is a good idea.</p>
<h1><a class="anchor" id="secttutoFMMErosion2"></a>
Some steps</h1>
<p>We will detail the implementation of some crucial steps:</p>
<ul>
<li>reading a vol image.</li>
<li>tracking a digital surface.</li>
<li>performing a local erosion by <a class="el" href="classDGtal_1_1FMM.html" title="Aim: Fast Marching Method (FMM) for nd distance transforms. ">FMM</a>.</li>
<li>writing a vol image.</li>
</ul>
<p>The whole example is available in <a class="el" href="FMMErosion_8cpp_source.html">FMMErosion.cpp</a>.</p>
<h2><a class="anchor" id="subsecttutoFMMErosion21"></a>
Reading a vol</h2>
<p>First of all, we choose a type for the binary image representing the 3d volume. Then, we create the image and fill it by reading a vol file with <a class="el" href="structDGtal_1_1VolReader.html" title="Aim: implements methods to read a &quot;Vol&quot; file format. ">VolReader</a>.</p>
<div class="fragment"><div class="line">  <span class="keywordtype">string</span> imageFileName = examplesPath + <span class="stringliteral">&quot;samples/cat10.vol&quot;</span>; </div><div class="line">  <a class="code" href="namespaceDGtal.html#a8fc7012708b0416880a5c8b12dfdf9dd">trace</a>.<a class="code" href="classDGtal_1_1Trace.html#ad054990834d2763627166540087a2980">info</a>() &lt;&lt; imageFileName &lt;&lt;std::endl; </div><div class="line">  <span class="keyword">typedef</span> ImageContainerBySTLVector&lt;Domain, bool&gt; BinaryImage; </div><div class="line">  BinaryImage binaryImage = <a class="code" href="structDGtal_1_1VolReader.html#aa4f1ebd956ed345e4c64e78c83da25d2">VolReader&lt;BinaryImage&gt;::importVol</a>( imageFileName);</div></div><!-- fragment --><p> See also <a class="el" href="moduleIO.html">Image and digital object import/export</a>.</p>
<h2><a class="anchor" id="subsecttutoFMMErosion22"></a>
Tracking a surface</h2>
<p>We now track the digital surface of the volume in order to work in a narrow band around it.</p>
<p>This can be done in two steps:</p>
<ul>
<li>We search for a boundary element (<em>bel</em> for short), i.e. a surfel lying between the volume and its background.</li>
</ul>
<div class="fragment"><div class="line">  <a class="code" href="namespaceDGtal_1_1Z2i.html#a6183d00ec6f8c4f81748fd20a52e5590">KSpace</a> ks;</div><div class="line">  Domain domain = binaryImage.domain(); </div><div class="line">  ks.init( domain.lowerBound(), domain.upperBound(), true ); </div><div class="line">  KSpace::SCell bel;</div><div class="line"></div><div class="line">  <span class="keywordflow">try</span> { </div><div class="line">    <span class="comment">//getting a bel</span></div><div class="line">    bel = <a class="code" href="classDGtal_1_1Surfaces.html#a48e3a0e7c4728f6a6f23ec6f468a41b8">Surfaces&lt;KSpace&gt;::findABel</a>( ks, binaryImage, domain.size() );</div><div class="line">    <a class="code" href="namespaceDGtal.html#a8fc7012708b0416880a5c8b12dfdf9dd">trace</a>.<a class="code" href="classDGtal_1_1Trace.html#ad054990834d2763627166540087a2980">info</a>() &lt;&lt; <span class="stringliteral">&quot;starting bel: &quot;</span> &lt;&lt; bel &lt;&lt; std::endl;</div><div class="line"> </div><div class="line">  } <span class="keywordflow">catch</span> (<a class="code" href="classDGtal_1_1InputException.html">DGtal::InputException</a> i) {</div><div class="line">    <a class="code" href="namespaceDGtal.html#a8fc7012708b0416880a5c8b12dfdf9dd">trace</a>.<a class="code" href="classDGtal_1_1Trace.html#a7b51b5b34d3c1d5e799e0500a2d12acc">emphase</a>() &lt;&lt; <span class="stringliteral">&quot;starting bel not found&quot;</span> &lt;&lt; std::endl; </div><div class="line">    <span class="keywordflow">return</span> 0; </div><div class="line">  }</div></div><!-- fragment --><ul>
<li>We define and track the digital surface from the starting bel.</li>
</ul>
<div class="fragment"><div class="line">  <span class="keyword">typedef</span> functors::FrontierPredicate&lt;KSpace, BinaryImage&gt; SurfelPredicate;</div><div class="line">  <span class="keyword">typedef</span> LightExplicitDigitalSurface&lt;KSpace, SurfelPredicate&gt; Frontier;</div><div class="line">  functors::SCellToIncidentPoints&lt;KSpace&gt; toIncidentPoints( ks );</div><div class="line">  std::pair&lt;Point,Point&gt; bpair = toIncidentPoints( bel );    </div><div class="line">  SurfelPredicate surfelPredicate( ks, binaryImage, </div><div class="line">                                   binaryImage( bpair.first ), </div><div class="line">                                   binaryImage( bpair.second ) );  </div><div class="line">  Frontier frontier( ks, surfelPredicate, </div><div class="line">                     SurfelAdjacency&lt;KSpace::dimension&gt;( <span class="keyword">true</span> ), bel ); </div></div><!-- fragment --> <dl class="section note"><dt>Note</dt><dd>In this snippet, we do not explicitly track the digital surface. The digital surface is <em>light</em>, i.e. it does not contain any surfel, but computes them on-line.</dd></dl>
<p>See also <a class="el" href="moduleDigitalSurfaces.html">Digital surfaces</a> and <a class="el" href="moduleDigitalSurfaceHelpers.html">Helpers for digital surfaces</a>.</p>
<h2><a class="anchor" id="subsecttutoFMMErosion23"></a>
Local erosion</h2>
<p>In order to perform a local morphological erosion, the idea is to incrementally compute the band of points to remove by marching out from the digital surface, but only <em>inside</em> the initial volume. We stop as soon as we detect a point whose (Euclidean) distance from the digital surface is greater than a given threshold (called <em>maximalDistance</em> below), which corresponds to the radius of the structuring element.</p>
<p>As explained in <a class="el" href="moduleFMM.html">nD Fast Marching Methods</a>, we must define</p><ul>
<li>a type for the set of points for which we compute the distance values (called AcceptedPointSet below),</li>
<li>a type for the image that stores the distance values (called DistanceImage below),</li>
<li>a type for the point predicate that implicitly represents the volume. Here, we use the binary image as a point predicate.</li>
</ul>
<div class="fragment"><div class="line">  <span class="keyword">typedef</span> ImageContainerBySTLMap&lt;Domain,double&gt; DistanceImage; </div><div class="line">  <span class="keyword">typedef</span> DigitalSetFromMap&lt;DistanceImage&gt; AcceptedPointSet; </div><div class="line">  <span class="keyword">typedef</span> FMM&lt;DistanceImage, AcceptedPointSet, BinaryImage &gt; FMM;</div></div><!-- fragment --><p> Then, we construct and initalize the two external data structures, i.e. the set of points and the image of distance values. We arbitrarily set the distance values of all the inner points to \( 0.5 \).</p>
<div class="fragment"><div class="line">  DistanceImage imageDistance( domain, 0.0 );</div><div class="line">  AcceptedPointSet pointSet( imageDistance );</div><div class="line">  functors::SCellToInnerPoint&lt;KSpace&gt; toInnerPoint( ks );</div><div class="line">  <span class="keywordflow">for</span> (Frontier::SurfelConstIterator it = frontier.begin(), itEnd = frontier.end(); </div><div class="line">       it != itEnd; ++it) </div><div class="line">    {</div><div class="line">      pointSet.insert( toInnerPoint(*it) ); </div><div class="line">      imageDistance.setValue( toInnerPoint(*it), 0.5 ); </div><div class="line">    }</div></div><!-- fragment --><p> Finally, we instanciate the <a class="el" href="classDGtal_1_1FMM.html" title="Aim: Fast Marching Method (FMM) for nd distance transforms. ">FMM</a> class and perform the computation as follows:</p>
<div class="fragment"><div class="line">  FMM fmm( imageDistance, pointSet, binaryImage,</div><div class="line">           domain.size(), maximalDistance );</div><div class="line">  fmm.compute(); </div><div class="line">  <a class="code" href="namespaceDGtal.html#a8fc7012708b0416880a5c8b12dfdf9dd">trace</a>.<a class="code" href="classDGtal_1_1Trace.html#ad054990834d2763627166540087a2980">info</a>() &lt;&lt; fmm &lt;&lt; std::endl;  </div></div><!-- fragment --><p> Note that we set the last (optional) argument to <em>maximalDistance</em> in order to bound the computation. Consequently, it remains to flip from the volume to the background all the points belonging to <em>pointSet</em>. Indeed, they are all located inside the volume, at a distance from the digital surface that is less than <em>maximalDistance</em> by definition.</p>
<div class="fragment"><div class="line">  <span class="keywordflow">for</span> (AcceptedPointSet::ConstIterator it = pointSet.begin(), itEnd = pointSet.end(); </div><div class="line">       it != itEnd; ++it) </div><div class="line">    {</div><div class="line">      binaryImage.setValue(*it, 0); </div><div class="line">    }</div></div><!-- fragment --> <h2><a class="anchor" id="subsecttutoFMMErosion24"></a>
Writing a vol</h2>
<p>In order to export the updated binary image in a vol file, we use <a class="el" href="structDGtal_1_1VolWriter.html" title="Aim: Export a 3D Image using the Vol formats. ">VolWriter</a> as follows:</p>
<div class="fragment"><div class="line">  <span class="keywordtype">string</span> outputFileName = <span class="stringliteral">&quot;eroded.vol&quot;</span>; </div><div class="line">  <a class="code" href="namespaceDGtal.html#a8fc7012708b0416880a5c8b12dfdf9dd">trace</a>.<a class="code" href="classDGtal_1_1Trace.html#ad054990834d2763627166540087a2980">info</a>() &lt;&lt; <span class="stringliteral">&quot;to &quot;</span> &lt;&lt; outputFileName &lt;&lt; std::endl; </div><div class="line">  VolWriter&lt;BinaryImage,functors::Cast&lt;unsigned char&gt; &gt;::exportVol(outputFileName, binaryImage);</div></div><!-- fragment --> <dl class="section note"><dt>Note</dt><dd>In order to visualize a vol file with QGLViewer, you can use the tool <em>3dVolViewer</em> of the DGtalTools project (<a href="https://github.com/DGtal-team/DGtalTools">https://github.com/DGtal-team/DGtalTools</a>).</dd></dl>
<h1><a class="anchor" id="secttutoFMMErosion3"></a>
Your challenge</h1>
<p>You know how to perform a local morphological erosion. All the previous snippets are taken from <a class="el" href="FMMErosion_8cpp_source.html">FMMErosion.cpp</a>. The local morphological dilation as well as the final morphological opening, which is an erosion followed by a dilation, are left as an exercise.</p>
<h2><a class="anchor" id="subsecttutoFMMErosion31"></a>
Excercise</h2>
<p>Your challenge is to code:</p>
<ol type="1">
<li>a local morphological dilation,</li>
<li>a local morphological opening,</li>
<li>a tool that performs a local morphological opening on all connected components. The vol file and the radius of the structural element must be program options.</li>
</ol>
<h2><a class="anchor" id="subsecttutoFMMErosion32"></a>
Hints</h2>
<p>The dilation operation will look like the erosion operation. There are however three small differences:</p>
<ul>
<li>Contrary to the erosion operation that is bounded by the volume, the dilation operation must be limited to the background, but inside the domain. On one hand, you may adapt the binary image, used as a point predicate in <a class="el" href="FMMErosion_8cpp_source.html">FMMErosion.cpp</a>, with <a class="el" href="structDGtal_1_1functors_1_1NotPointPredicate.html" title="Aim: The predicate returns true when the point predicate given at construction return false...">functors::NotPointPredicate</a> in order to bound the computation to the background. On the other hand, you may adapt the domain with <a class="el" href="structDGtal_1_1functors_1_1DomainPredicate.html" title="Aim: The predicate returning true iff the point is in the domain given at construction. It is just a wrapper class around the methods Domain::isInside( const Point &amp; ), where Domain stands for any model of CDomain. ">functors::DomainPredicate</a> in order to limit the computation to the domain. Finally, you may use <a class="el" href="structDGtal_1_1functors_1_1BinaryPointPredicate.html" title="Aim: The predicate returns true when the given binary functor returns true for the two PointPredicate...">functors::BinaryPointPredicate</a> to combine these two point predicates. Thus, you may define the following types:</li>
</ul>
<div class="fragment"><div class="line"><span class="keyword">using namespace </span><a class="code" href="namespaceDGtal_1_1functors.html">DGtal::functors</a>;</div><div class="line"><span class="keyword">typedef</span> <a class="code" href="structDGtal_1_1functors_1_1NotPointPredicate.html">NotPointPredicate&lt;BinaryImage&gt;</a> BackgroundPredicate; </div><div class="line"><span class="keyword">typedef</span> <a class="code" href="structDGtal_1_1functors_1_1BinaryPointPredicate.html">BinaryPointPredicate</a>&lt;</div><div class="line">  BackgroundPredicate, </div><div class="line">  <a class="code" href="structDGtal_1_1functors_1_1DomainPredicate.html">DomainPredicate&lt;Domain&gt;</a> &gt; Predicate;            </div></div><!-- fragment --><p>Once these types are defined, you can construct your new point predicate as follows:</p>
<div class="fragment"><div class="line">BackgroundPredicate backgroundPredicate( binaryImage );</div><div class="line">DomainPredicate&lt;Domain&gt; domainPredicate( domain );</div><div class="line">Predicate pred( backgroundPredicate, domainPredicate, andBF2 ); </div></div><!-- fragment --><p>Note that most point predicate adapters are defined in <a class="el" href="BasicPointPredicates_8h_source.html">BasicPointPredicates.h</a>. Moreover, <a class="el" href="namespaceDGtal_1_1functors.html#a75f64f8aec85ed2085df8d5c13947324">functors::andBF2</a> is a binary functor defined in <a class="el" href="BasicBoolFunctors_8h_source.html">BasicBoolFunctors.h</a></p>
<ul>
<li>You must initialize the accepted point set from the outer points of the digital surface. You may use <a class="el" href="classDGtal_1_1functors_1_1SCellToOuterPoint.html" title="Aim: transforms a signed cell c into a point corresponding to the signed cell of greater dimension th...">functors::SCellToOuterPoint</a> defined in <a class="el" href="SCellsFunctors_8h_source.html">SCellsFunctors.h</a> instead of <a class="el" href="classDGtal_1_1functors_1_1SCellToInnerPoint.html" title="Aim: transforms a signed cell c into a point corresponding to the signed cell of greater dimension th...">functors::SCellToInnerPoint</a>.</li>
<li>Obviously, after the computation, you must flip the points of the accepted point set from the background to the volume in order to complete the dilation operation. </li>
</ul>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Fri Jan 22 2016 21:11:42 for DGtal by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
