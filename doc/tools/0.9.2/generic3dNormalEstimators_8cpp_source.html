<!-- HTML header for doxygen 1.8.11-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>DGtalTools: generic3dNormalEstimators.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="modern-doxygen-green.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">DGtalTools 
   &#160;<span id="projectnumber">0.9.2</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_ad421f26fc787a8055cabb4d5b02df31.html">estimators</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">generic3dNormalEstimators.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="preprocessor">#include &lt;iostream&gt;</span></div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="preprocessor">#include &lt;fstream&gt;</span></div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="preprocessor">#include &lt;sstream&gt;</span></div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="preprocessor">#include &lt;boost/program_options/options_description.hpp&gt;</span></div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="preprocessor">#include &lt;boost/program_options/parsers.hpp&gt;</span></div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="preprocessor">#include &lt;boost/program_options/variables_map.hpp&gt;</span></div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="preprocessor">#include &quot;DGtal/base/Common.h&quot;</span></div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="preprocessor">#include &quot;DGtal/base/CountedPtr.h&quot;</span></div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="preprocessor">#include &quot;DGtal/base/CountedConstPtrOrConstPtr.h&quot;</span></div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="preprocessor">#include &quot;DGtal/helpers/StdDefs.h&quot;</span></div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="preprocessor">#include &quot;DGtal/math/Statistic.h&quot;</span></div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="preprocessor">#include &quot;DGtal/math/MPolynomial.h&quot;</span></div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="preprocessor">#include &quot;DGtal/topology/LightImplicitDigitalSurface.h&quot;</span></div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="preprocessor">#include &quot;DGtal/graph/DepthFirstVisitor.h&quot;</span></div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="preprocessor">#include &quot;DGtal/graph/GraphVisitorRange.h&quot;</span></div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="preprocessor">#include &quot;DGtal/geometry/surfaces/estimation/CNormalVectorEstimator.h&quot;</span></div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="preprocessor">#include &quot;DGtal/geometry/surfaces/estimation/VoronoiCovarianceMeasureOnDigitalSurface.h&quot;</span></div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="preprocessor">#include &quot;DGtal/geometry/surfaces/estimation/VCMDigitalSurfaceLocalEstimator.h&quot;</span></div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="preprocessor">#include &quot;DGtal/geometry/surfaces/estimation/TrueDigitalSurfaceLocalEstimator.h&quot;</span></div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="preprocessor">#include &quot;DGtal/geometry/surfaces/estimation/IIGeometricFunctors.h&quot;</span></div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="preprocessor">#include &quot;DGtal/geometry/surfaces/estimation/IntegralInvariantCovarianceEstimator.h&quot;</span></div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="preprocessor">#include &quot;DGtal/geometry/volumes/KanungoNoise.h&quot;</span></div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="preprocessor">#include &quot;DGtal/shapes/GaussDigitizer.h&quot;</span></div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="preprocessor">#include &quot;DGtal/shapes/ShapeGeometricFunctors.h&quot;</span></div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="preprocessor">#include &quot;DGtal/shapes/implicit/ImplicitPolynomial3Shape.h&quot;</span></div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="preprocessor">#include &quot;DGtal/images/ImageContainerBySTLVector.h&quot;</span></div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="preprocessor">#include &quot;DGtal/images/SimpleThresholdForegroundPredicate.h&quot;</span></div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;<span class="preprocessor">#include &quot;DGtal/io/readers/MPolynomialReader.h&quot;</span></div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;<span class="preprocessor">#include &quot;DGtal/io/colormaps/GradientColorMap.h&quot;</span></div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="preprocessor">#ifdef WITH_VISU3D_QGLVIEWER</span></div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="preprocessor">#include &quot;DGtal/io/viewers/Viewer3D.h&quot;</span></div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="preprocessor">#include &quot;DGtal/io/Display3DFactory.h&quot;</span></div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;<span class="keyword">using namespace </span><a class="code" href="namespacestd.html">std</a>;</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;<span class="keyword">using namespace </span><a class="code" href="namespaceDGtal.html">DGtal</a>;</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;<span class="keyword">namespace </span>po = boost::program_options;</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;<span class="keyword">template</span> &lt;<span class="keyword">typename</span> SCell, <span class="keyword">typename</span> RealVector&gt;</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;<span class="keyword">struct </span>GradientMapAdapter {</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;  <span class="keyword">typedef</span> std::map&lt;SCell,RealVector&gt; SCell2RealVectorMap;</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;  <span class="keyword">typedef</span> SCell                                 Argument;</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;  <span class="keyword">typedef</span> RealVector                               Value;</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;  GradientMapAdapter( ConstAlias&lt;SCell2RealVectorMap&gt; map )</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;    : myMap( map ) {}</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;  RealVector operator()( <span class="keyword">const</span> Argument&amp; arg )<span class="keyword"> const</span></div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;<span class="keyword">  </span>{</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    <span class="keyword">typename</span> SCell2RealVectorMap::const_iterator it = myMap-&gt;find( arg );</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;    <span class="keywordflow">if</span> ( it != myMap-&gt;end() ) <span class="keywordflow">return</span> it-&gt;second;</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">return</span> RealVector();</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;  }</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;  CountedConstPtrOrConstPtr&lt;SCell2RealVectorMap&gt; myMap;</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;};</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;<span class="keyword">template</span> &lt;<span class="keyword">typename</span> SCellEmbedder&gt;</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;<span class="keyword">struct </span>SCellEmbedderWithNormal : <span class="keyword">public</span> SCellEmbedder</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;{</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;  <span class="keyword">using</span> SCellEmbedder::space;</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;  <span class="keyword">using</span> SCellEmbedder::operator();</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;  <span class="keyword">typedef</span> <span class="keyword">typename</span> SCellEmbedder::KSpace          KSpace;</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;  <span class="keyword">typedef</span> <span class="keyword">typename</span> SCellEmbedder::SCell            SCell;</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;  <span class="keyword">typedef</span> <span class="keyword">typename</span> SCellEmbedder::RealPoint    RealPoint;</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;  <span class="keyword">typedef</span> SCell                                 Argument;</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;  <span class="keyword">typedef</span> RealPoint                                Value;</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;  <span class="keyword">typedef</span> <span class="keyword">typename</span> KSpace::Space::RealVector  RealVector;</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;  <span class="keyword">typedef</span> std::map&lt;SCell,RealVector&gt; SCell2RealVectorMap;</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;  <span class="keyword">typedef</span> GradientMapAdapter&lt;SCell,RealVector&gt; GradientMap;</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;  SCellEmbedderWithNormal( ConstAlias&lt;SCellEmbedder&gt; embedder,</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;                           ConstAlias&lt;SCell2RealVectorMap&gt; map )</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;    : SCellEmbedder( embedder ), myMap( map )</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;  {}</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;  GradientMap gradientMap()<span class="keyword"> const</span></div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;<span class="keyword">  </span>{</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;    <span class="keywordflow">return</span> GradientMap( myMap );</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;  }</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;  CountedConstPtrOrConstPtr&lt;SCell2RealVectorMap&gt; myMap;</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;};</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;<span class="keyword">template</span> &lt;<span class="keyword">typename</span> DigitalSurface,</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;          <span class="keyword">typename</span> Estimator&gt;</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;<span class="keywordtype">void</span> exportNOFFSurface( <span class="keyword">const</span> DigitalSurface&amp; surface,</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;                        <span class="keyword">const</span> Estimator&amp; estimator,</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;                        std::ostream&amp; output )</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;{</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;  <span class="keyword">typedef</span> <span class="keyword">typename</span> DigitalSurface::KSpace KSpace;</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;  <span class="keyword">typedef</span> <span class="keyword">typename</span> DigitalSurface::ConstIterator ConstIterator;</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;  <span class="keyword">typedef</span> <span class="keyword">typename</span> DigitalSurface::Surfel Surfel;</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;  <span class="keyword">typedef</span> <span class="keyword">typename</span> KSpace::SCell SCell;</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;  <span class="keyword">typedef</span> <span class="keyword">typename</span> Estimator::Quantity Quantity;</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;  <span class="keyword">const</span> KSpace&amp; ks = surface.container().space();</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;  std::map&lt;Surfel,Quantity&gt; normals;</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;  <span class="keywordflow">for</span> ( ConstIterator it = surface.begin(), itE = surface.end(); it != itE; ++it )</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;    {</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;      Quantity n_est = estimator.eval( it );</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;      normals[ *it ] = n_est;</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;    }</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;  CanonicSCellEmbedder&lt;KSpace&gt; surfelEmbedder( ks );</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;  <span class="keyword">typedef</span> SCellEmbedderWithNormal&lt; CanonicSCellEmbedder&lt;KSpace&gt; &gt; Embedder;</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;  Embedder embedder( surfelEmbedder, normals );</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;  surface.exportAs3DNOFF( output, embedder );</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;}</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;<span class="keyword">template</span> &lt;<span class="keyword">typename</span> KSpace,</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;          <span class="keyword">typename</span> ImplicitShape,</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;          <span class="keyword">typename</span> Surface,</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;          <span class="keyword">typename</span> TrueEstimator,</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;          <span class="keyword">typename</span> Estimator&gt;</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;<span class="keywordtype">void</span> computeEstimation</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;( <span class="keyword">const</span> po::variables_map&amp; vm,     <span class="comment">//&lt; command-line parameters</span></div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;  <span class="keyword">const</span> KSpace&amp; K,                 <span class="comment">//&lt; cellular grid space</span></div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;  <span class="keyword">const</span> ImplicitShape&amp; shape,      <span class="comment">//&lt; implicit shape &quot;ground truth&quot;</span></div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;  <span class="keyword">const</span> Surface&amp; surface,          <span class="comment">//&lt; digital surface approximating shape</span></div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;  TrueEstimator&amp; true_estimator,   <span class="comment">//&lt; &quot;ground truth&quot; estimator</span></div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;  Estimator&amp; estimator )           <span class="comment">//&lt; an initialized estimator</span></div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;{</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;  <span class="keyword">typedef</span> <span class="keyword">typename</span> Surface::ConstIterator ConstIterator;</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;  <span class="keyword">typedef</span> <span class="keyword">typename</span> Surface::Surfel Surfel;</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;  <span class="keyword">typedef</span> <span class="keyword">typename</span> Estimator::Quantity Quantity;</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;  <span class="keyword">typedef</span> <span class="keywordtype">double</span> Scalar;</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;  <span class="keyword">typedef</span> DepthFirstVisitor&lt; Surface &gt; Visitor;</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;  <span class="keyword">typedef</span> GraphVisitorRange&lt; Visitor &gt; VisitorRange;</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;  <span class="keyword">typedef</span> <span class="keyword">typename</span> VisitorRange::ConstIterator VisitorConstIterator;</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;  std::string fname = vm[ <span class="stringliteral">&quot;output&quot;</span> ].as&lt;std::string&gt;();</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;  <span class="keywordtype">string</span> nameEstimator = vm[ <span class="stringliteral">&quot;estimator&quot;</span> ].as&lt;<span class="keywordtype">string</span>&gt;();</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;  trace.beginBlock( <span class="stringliteral">&quot;Computing &quot;</span> + nameEstimator + <span class="stringliteral">&quot;estimations.&quot;</span> );</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;  CountedPtr&lt;VisitorRange&gt; range( <span class="keyword">new</span> VisitorRange( <span class="keyword">new</span> Visitor( surface, *(surface.begin()) )) );</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;  std::vector&lt;Quantity&gt; n_estimations;</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;  estimator.eval( range-&gt;begin(), range-&gt;end(), std::back_inserter( n_estimations ) );</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;  trace.info() &lt;&lt; <span class="stringliteral">&quot;- nb estimations  = &quot;</span> &lt;&lt; n_estimations.size() &lt;&lt; std::endl;</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;  trace.endBlock();</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;  trace.beginBlock( <span class="stringliteral">&quot;Computing ground truth.&quot;</span> );</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;  range = CountedPtr&lt;VisitorRange&gt;( <span class="keyword">new</span> VisitorRange( <span class="keyword">new</span> Visitor( surface, *(surface.begin()) )) );</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;  std::vector&lt;Quantity&gt; n_true_estimations;</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;  true_estimator.eval( range-&gt;begin(), range-&gt;end(), std::back_inserter( n_true_estimations ) );</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;  trace.info() &lt;&lt; <span class="stringliteral">&quot;- nb estimations  = &quot;</span> &lt;&lt; n_true_estimations.size() &lt;&lt; std::endl;</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;  trace.endBlock();</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;  trace.beginBlock( <span class="stringliteral">&quot;Correcting orientations.&quot;</span> );</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;  ASSERT( n_estimations.size() == n_true_estimations.size() );</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;  <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; n_estimations.size(); ++i )</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;    <span class="keywordflow">if</span> ( n_estimations[ i ].dot( n_true_estimations[ i ] ) &lt; 0 )</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;      n_estimations[ i ] = -n_estimations[ i ];</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;  trace.endBlock();</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;  DGtal::GradientColorMap&lt;double&gt; grad( 0.0, 40.0 );</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;  <span class="comment">// 0 metallic blue, 5 light cyan, 10 light green, 15 light</span></div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;  <span class="comment">// yellow, 20 yellow, 25 orange, 30 red, 35, dark red, 40- grey</span></div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;  grad.addColor( DGtal::Color( 128, 128, 255 ) ); <span class="comment">// 0</span></div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;  grad.addColor( DGtal::Color( 128, 255, 255 ) ); <span class="comment">// 5</span></div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;  grad.addColor( DGtal::Color( 128, 255, 128 ) ); <span class="comment">// 10</span></div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;  grad.addColor( DGtal::Color( 255, 255, 128 ) ); <span class="comment">// 15</span></div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;  grad.addColor( DGtal::Color( 255, 255, 0   ) ); <span class="comment">// 20</span></div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;  grad.addColor( DGtal::Color( 255, 128, 0   ) ); <span class="comment">// 25</span></div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;  grad.addColor( DGtal::Color( 255,   0, 0   ) ); <span class="comment">// 30</span></div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;  grad.addColor( DGtal::Color( 128,   0, 0   ) ); <span class="comment">// 35</span></div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;  grad.addColor( DGtal::Color( 128, 128, 128 ) ); <span class="comment">// 40</span></div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;  <span class="keywordflow">if</span> ( vm.count( <span class="stringliteral">&quot;angle-deviation-stats&quot;</span> ) )</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;    {</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;      trace.beginBlock( <span class="stringliteral">&quot;Computing angle deviation error stats.&quot;</span> );</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;      std::ostringstream adev_sstr;</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;      adev_sstr &lt;&lt; fname &lt;&lt; <span class="stringliteral">&quot;-&quot;</span> &lt;&lt; nameEstimator &lt;&lt; <span class="stringliteral">&quot;-angle-deviation-&quot;</span></div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;                &lt;&lt; estimator.h() &lt;&lt; <span class="stringliteral">&quot;.txt&quot;</span>;</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;      DGtal::Statistic&lt;Scalar&gt; adev_stat;</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;      <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0;</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;      range = CountedPtr&lt;VisitorRange&gt;( <span class="keyword">new</span> VisitorRange( <span class="keyword">new</span> Visitor( surface, *(surface.begin()) )) );</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;      <span class="keywordflow">for</span> ( VisitorConstIterator it = range-&gt;begin(), itE = range-&gt;end(); it != itE; ++it, ++i )</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;        {</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;          Quantity n_est = n_estimations[ i ];</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;          Quantity n_true_est = n_true_estimations[ i ];</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;          Scalar angle_error = acos( n_est.dot( n_true_est ) );</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;          adev_stat.addValue( angle_error );</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;        }</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;      adev_stat.terminate();</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;      std::ofstream adev_output( adev_sstr.str().c_str() );</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;      adev_output &lt;&lt; <span class="stringliteral">&quot;# Average error X of the absolute angle between two vector estimations.&quot;</span> &lt;&lt; std::endl;</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;      adev_output &lt;&lt; <span class="stringliteral">&quot;# h L1 L2 Loo E[X] Var[X] Min[X] Max[X] Nb[X]&quot;</span> &lt;&lt; std::endl;</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;      adev_output &lt;&lt; estimator.h()</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;                  &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; adev_stat.mean() <span class="comment">// L1</span></div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;                  &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; sqrt( adev_stat.unbiasedVariance()</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;                                  + adev_stat.mean()*adev_stat.mean() ) <span class="comment">// L2</span></div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;                  &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; adev_stat.max() <span class="comment">// Loo</span></div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;                  &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; adev_stat.mean() <span class="comment">// E[X] (=L1)</span></div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;                  &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; adev_stat.unbiasedVariance() <span class="comment">// Var[X]</span></div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;                  &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; adev_stat.min() <span class="comment">// Min[X]</span></div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;                  &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; adev_stat.max() <span class="comment">// Max[X]</span></div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;                  &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; adev_stat.samples() <span class="comment">// Nb[X]</span></div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;                  &lt;&lt; std::endl;</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;      adev_output.close();</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;      trace.endBlock();</div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;    }</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;  <span class="keywordflow">if</span> ( vm[ <span class="stringliteral">&quot;export&quot;</span> ].as&lt;string&gt;() != <span class="stringliteral">&quot;None&quot;</span> )</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;    {</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;      trace.beginBlock( <span class="stringliteral">&quot;Exporting cell geometry.&quot;</span> );</div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;      std::ostringstream export_sstr;</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;      export_sstr &lt;&lt; fname &lt;&lt; <span class="stringliteral">&quot;-&quot;</span> &lt;&lt; nameEstimator &lt;&lt; <span class="stringliteral">&quot;-cells-&quot;</span></div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;                  &lt;&lt; estimator.h() &lt;&lt; <span class="stringliteral">&quot;.txt&quot;</span>;</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;      std::ofstream export_output( export_sstr.str().c_str() );</div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;      export_output &lt;&lt; <span class="stringliteral">&quot;# ImaGene viewer (viewSetOfSurfels) file format for displaying cells.&quot;</span> &lt;&lt; std::endl;</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;      <span class="keywordtype">bool</span> adev =  vm[ <span class="stringliteral">&quot;export&quot;</span> ].as&lt;<span class="keywordtype">string</span>&gt;() == <span class="stringliteral">&quot;AngleDeviation&quot;</span>;</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;      <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0;</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;      range = CountedPtr&lt;VisitorRange&gt;( <span class="keyword">new</span> VisitorRange( <span class="keyword">new</span> Visitor( surface, *(surface.begin()) )) );</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;      <span class="keywordflow">for</span> ( VisitorConstIterator it = range-&gt;begin(), itE = range-&gt;end(); it != itE; ++it, ++i )</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;        {</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;          Quantity n_est = n_estimations[ i ];</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;          Quantity n_true_est = n_true_estimations[ i ];</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;          Scalar angle_error = acos( n_est.dot( n_true_est ) )*180.0 / 3.14159625;</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;          Surfel s = *it;</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;          export_output</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;            &lt;&lt; <span class="stringliteral">&quot;CellN&quot;</span></div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;            &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; min( 1023, max( 512+K.sKCoord( s, 0 ), 0 ) )</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;            &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; min( 1023, max( 512+K.sKCoord( s, 1 ), 0 ) )</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;            &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; min( 1023, max( 512+K.sKCoord( s, 2 ), 0 ) )</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;            &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; K.sSign( s );</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;          Color c = grad( 0 );</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;          <span class="keywordflow">if</span> ( adev ) c = grad( max( 0.0, min( angle_error, 40.0 ) ) );</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;          export_output &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; ((double) c.red() / 255.0 )</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;                        &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; ((<span class="keywordtype">double</span>) c.green() / 255.0 )</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;                        &lt;&lt; &quot; &quot; &lt;&lt; ((<span class="keywordtype">double</span>) c.blue() / 255.0 );</div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;          export_output &lt;&lt; &quot; &quot; &lt;&lt; n_est[ 0 ] &lt;&lt; &quot; &quot; &lt;&lt; n_est[ 1 ]</div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;                        &lt;&lt; &quot; &quot; &lt;&lt; n_est[ 2 ] &lt;&lt; <a class="code" href="namespacestd.html">std</a>::endl;</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;        }</div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;      export_output.close();</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;      trace.endBlock();</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;    }</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;  if ( vm.count( &quot;normals&quot; ) )</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;    {</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;      trace.beginBlock( <span class="stringliteral">&quot;Exporting cells normals.&quot;</span> );</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;      std::ostringstream export_sstr;</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;      export_sstr &lt;&lt; fname &lt;&lt; <span class="stringliteral">&quot;-&quot;</span> &lt;&lt; nameEstimator &lt;&lt; <span class="stringliteral">&quot;-normals-&quot;</span></div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;                  &lt;&lt; estimator.h() &lt;&lt; <span class="stringliteral">&quot;.txt&quot;</span>;</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;      std::ofstream export_output( export_sstr.str().c_str() );</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;      export_output &lt;&lt; <span class="stringliteral">&quot;# kx ky kz sign n_est[0] n_est[1] n_est[2] n_true[0] n_true[1] n_true[2]&quot;</span> &lt;&lt; std::endl;</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;      <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0;</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;      range = CountedPtr&lt;VisitorRange&gt;( <span class="keyword">new</span> VisitorRange( <span class="keyword">new</span> Visitor( surface, *(surface.begin()) )) );</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;      <span class="keywordflow">for</span> ( VisitorConstIterator it = range-&gt;begin(), itE = range-&gt;end(); it != itE; ++it, ++i )</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;        {</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;          Quantity n_est = n_estimations[ i ];</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;          Quantity n_true_est = n_true_estimations[ i ];</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;          Surfel s = *it;</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;          export_output</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;            &lt;&lt; K.sKCoord( s, 0 ) &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; K.sKCoord( s, 1 ) &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; K.sKCoord( s, 2 )</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;            &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; K.sSign( s )</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;            &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; n_est[ 0 ] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; n_est[ 1 ] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; n_est[ 2 ]</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;            &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; n_true_est[ 0 ] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; n_true_est[ 1 ] &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; n_true_est[ 2 ]</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;            &lt;&lt; std::endl;</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;        }</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;      export_output.close();</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;      trace.endBlock();</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;    }</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;  <span class="keywordflow">if</span> ( vm.count( <span class="stringliteral">&quot;noff&quot;</span> ) )</div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;    {</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;      trace.beginBlock( <span class="stringliteral">&quot;Exporting NOFF file.&quot;</span> );</div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;      std::ostringstream export_sstr;</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;      export_sstr &lt;&lt; fname &lt;&lt; <span class="stringliteral">&quot;-&quot;</span> &lt;&lt; nameEstimator &lt;&lt; <span class="stringliteral">&quot;-noff-&quot;</span></div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;                  &lt;&lt; estimator.h() &lt;&lt; <span class="stringliteral">&quot;.off&quot;</span>;</div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;      std::ofstream export_output( export_sstr.str().c_str() );</div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;      std::map&lt;Surfel,Quantity&gt; normals;</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;      <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0;</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;      range = CountedPtr&lt;VisitorRange&gt;( <span class="keyword">new</span> VisitorRange( <span class="keyword">new</span> Visitor( surface, *(surface.begin()) )) );</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;      <span class="keywordflow">for</span> ( VisitorConstIterator it = range-&gt;begin(), itE = range-&gt;end(); it != itE; ++it, ++i )</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;        {</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;          Quantity n_est = n_estimations[ i ];</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;          normals[ *it ] = n_est;</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;        }</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;      CanonicSCellEmbedder&lt;KSpace&gt; surfelEmbedder( K );</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;      <span class="keyword">typedef</span> SCellEmbedderWithNormal&lt; CanonicSCellEmbedder&lt;KSpace&gt; &gt; Embedder;</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;      Embedder embedder( surfelEmbedder, normals );</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;      surface.exportAs3DNOFF( export_output, embedder );</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;      export_output.close();</div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;      trace.endBlock();</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;    }</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;<span class="preprocessor">#ifdef WITH_VISU3D_QGLVIEWER</span></div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;  <span class="keywordflow">if</span> ( vm[ <span class="stringliteral">&quot;view&quot;</span> ].as&lt;string&gt;() != <span class="stringliteral">&quot;None&quot;</span> )</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;    {</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;      <span class="keyword">typedef</span> <span class="keyword">typename</span> KSpace::Space Space;</div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;      <span class="keyword">typedef</span> Viewer3D&lt;Space,KSpace&gt; MyViewever3D;</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;      <span class="keyword">typedef</span> Display3DFactory&lt;Space,KSpace&gt; MyDisplay3DFactory;</div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;      <span class="keywordtype">int</span> argc = 1;</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;      <span class="keywordtype">char</span> name[] = <span class="stringliteral">&quot;Viewer&quot;</span>;</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;      <span class="keywordtype">char</span>* argv[ 1 ];</div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;      argv[ 0 ] = name;</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;      Surfel s;</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;      QApplication application( argc, argv );</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;      MyViewever3D viewer( K );</div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;      viewer.show();</div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;      viewer &lt;&lt; SetMode3D( s.className(), <span class="stringliteral">&quot;Basic&quot;</span> );</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;      trace.beginBlock( <span class="stringliteral">&quot;Viewing surface.&quot;</span> );</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;      <span class="keywordtype">bool</span> adev =  vm[ <span class="stringliteral">&quot;view&quot;</span> ].as&lt;<span class="keywordtype">string</span>&gt;() == <span class="stringliteral">&quot;AngleDeviation&quot;</span>;</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;      <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0;</div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;      range = CountedPtr&lt;VisitorRange&gt;( <span class="keyword">new</span> VisitorRange( <span class="keyword">new</span> Visitor( surface, *(surface.begin()) )) );</div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;      <span class="keywordflow">for</span> ( VisitorConstIterator it = range-&gt;begin(), itE = range-&gt;end(); it != itE; ++it, ++i )</div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;        {</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;          Quantity n_est = n_estimations[ i ];</div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;          Quantity n_true_est = n_true_estimations[ i ];</div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;          Scalar angle_error = acos( n_est.dot( n_true_est ) )*180.0 / 3.14159625;</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;          s = *it;</div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;          Color c = grad( 0 );</div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;          <span class="keywordflow">if</span> ( adev ) c = grad( max( 0.0, min( angle_error, 40.0 ) ) );</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;          viewer.setFillColor( c );</div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;          MyDisplay3DFactory::drawOrientedSurfelWithNormal( viewer, s, n_est, <span class="keyword">false</span> );</div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;        }</div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;      trace.endBlock();</div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;      viewer &lt;&lt; MyViewever3D::updateDisplay;</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;      application.exec();</div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;    }</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;<span class="preprocessor">#endif</span></div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;</div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;}</div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;<span class="keyword">template</span> &lt;<span class="keyword">typename</span> KSpace,</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;          <span class="keyword">typename</span> ImplicitShape,</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;          <span class="keyword">typename</span> Surface,</div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;          <span class="keyword">typename</span> KernelFunction,</div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;          <span class="keyword">typename</span> PointPredicate&gt;</div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;<span class="keywordtype">void</span> chooseEstimator</div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;( <span class="keyword">const</span> po::variables_map&amp; vm,     <span class="comment">//&lt; command-line parameters</span></div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;  <span class="keyword">const</span> KSpace&amp; K,                 <span class="comment">//&lt; cellular grid space</span></div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;  <span class="keyword">const</span> ImplicitShape&amp; shape, <span class="comment">//&lt; implicit shape &quot;ground truth&quot;</span></div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;  <span class="keyword">const</span> Surface&amp; surface,     <span class="comment">//&lt; digital surface approximating shape</span></div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;  <span class="keyword">const</span> KernelFunction&amp; chi,  <span class="comment">//&lt; the kernel function</span></div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;  <span class="keyword">const</span> PointPredicate&amp; ptPred )   <span class="comment">//&lt; analysed implicit digital shape as a PointPredicate</span></div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;{</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;  <span class="keywordtype">string</span> nameEstimator = vm[ <span class="stringliteral">&quot;estimator&quot;</span> ].as&lt;<span class="keywordtype">string</span>&gt;();</div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;  <span class="keywordtype">double</span> h = vm[<span class="stringliteral">&quot;gridstep&quot;</span>].as&lt;<span class="keywordtype">double</span>&gt;();</div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;  <span class="keyword">typedef</span> functors::ShapeGeometricFunctors::ShapeNormalVectorFunctor&lt;ImplicitShape&gt; NormalFunctor;</div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;  <span class="keyword">typedef</span> TrueDigitalSurfaceLocalEstimator&lt;KSpace, ImplicitShape, NormalFunctor&gt; TrueEstimator;</div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;  TrueEstimator true_estimator;</div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;  true_estimator.attach( shape );</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;  true_estimator.setParams( K, NormalFunctor(), 20, 0.1, 0.01 );</div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;  true_estimator.init( h, surface.begin(), surface.end() );</div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;  <span class="keywordflow">if</span> ( nameEstimator == <span class="stringliteral">&quot;True&quot;</span> )</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;    {</div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;      trace.beginBlock( <span class="stringliteral">&quot;Chosen estimator is: True.&quot;</span> );</div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;      <span class="keyword">typedef</span> TrueDigitalSurfaceLocalEstimator&lt;KSpace, ImplicitShape, NormalFunctor&gt; Estimator;</div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;      Estimator estimator;</div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;      estimator.attach( shape );</div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;      estimator.setParams( K, NormalFunctor(), 20, 0.1, 0.01 );</div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;      estimator.init( h, surface.begin(), surface.end() );</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;      trace.endBlock();</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;      computeEstimation( vm, K, shape, surface, true_estimator, estimator );</div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;    }</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( nameEstimator == <span class="stringliteral">&quot;VCM&quot;</span> )</div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;    {</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;      trace.beginBlock( <span class="stringliteral">&quot;Chosen estimator is: VCM.&quot;</span> );</div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;      <span class="keyword">typedef</span> <span class="keyword">typename</span> KSpace::Space Space;</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;      <span class="keyword">typedef</span> <span class="keyword">typename</span> Surface::DigitalSurfaceContainer SurfaceContainer;</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;      <span class="keyword">typedef</span> ExactPredicateLpSeparableMetric&lt;Space,2&gt; Metric;</div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;      <span class="keyword">typedef</span> VoronoiCovarianceMeasureOnDigitalSurface&lt;SurfaceContainer,Metric,</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;                                                       KernelFunction&gt; VCMOnSurface;</div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;      <span class="keyword">typedef</span> functors::VCMNormalVectorFunctor&lt;VCMOnSurface&gt; NormalFunctor;</div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;      <span class="keyword">typedef</span> VCMDigitalSurfaceLocalEstimator&lt;SurfaceContainer,Metric,</div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;                                              KernelFunction, NormalFunctor&gt; VCMNormalEstimator;</div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;      <span class="keywordtype">int</span> embedding = vm[<span class="stringliteral">&quot;embedding&quot;</span>].as&lt;<span class="keywordtype">int</span>&gt;();</div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;      Surfel2PointEmbedding embType = embedding == 0 ? Pointels :</div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;                                      embedding == 1 ? InnerSpel : OuterSpel;</div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;      <span class="keywordtype">double</span> R = vm[<span class="stringliteral">&quot;R-radius&quot;</span>].as&lt;<span class="keywordtype">double</span>&gt;();</div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;      <span class="keywordtype">double</span> r = vm[<span class="stringliteral">&quot;r-radius&quot;</span>].as&lt;<span class="keywordtype">double</span>&gt;();</div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;      <span class="keywordtype">double</span> t = vm[<span class="stringliteral">&quot;trivial-radius&quot;</span>].as&lt;<span class="keywordtype">double</span>&gt;();</div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;      <span class="keywordtype">double</span> alpha = vm[<span class="stringliteral">&quot;alpha&quot;</span>].as&lt;<span class="keywordtype">double</span>&gt;();</div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;      <span class="keywordflow">if</span> ( alpha != 0.0 ) R *= pow( h, alpha-1.0 );</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;      <span class="keywordflow">if</span> ( alpha != 0.0 ) r *= pow( h, alpha-1.0 );</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;      trace.info() &lt;&lt; <span class="stringliteral">&quot;- R=&quot;</span> &lt;&lt; R &lt;&lt; <span class="stringliteral">&quot; r=&quot;</span> &lt;&lt; r &lt;&lt; <span class="stringliteral">&quot; t=&quot;</span> &lt;&lt; t &lt;&lt; std::endl;</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;      VCMNormalEstimator estimator;</div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;      estimator.attach( surface );</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;      estimator.setParams( embType, R, r, chi, t, Metric(), <span class="keyword">true</span> );</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;      estimator.init( h, surface.begin(), surface.end() );</div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;      trace.endBlock();</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;      computeEstimation( vm, K, shape, surface, true_estimator, estimator );</div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;    }</div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( nameEstimator == <span class="stringliteral">&quot;II&quot;</span> )</div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;    {</div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;      trace.beginBlock( <span class="stringliteral">&quot;Chosen estimator is: II.&quot;</span> );</div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;      <span class="keyword">typedef</span> <span class="keyword">typename</span> KSpace::Space Space;</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;      <span class="keyword">typedef</span> HyperRectDomain&lt;Space&gt; Domain;</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;      <span class="keyword">typedef</span> ImageContainerBySTLVector&lt; Domain, bool&gt; Image;</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;      <span class="keyword">typedef</span> <span class="keyword">typename</span> Domain::ConstIterator DomainConstIterator;</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;      <span class="keyword">typedef</span> functors::SimpleThresholdForegroundPredicate&lt;Image&gt; ThresholdedImage;</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;      <span class="keyword">typedef</span> functors::IINormalDirectionFunctor&lt;Space&gt; IINormalFunctor;</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;      <span class="keyword">typedef</span> IntegralInvariantCovarianceEstimator&lt;KSpace, ThresholdedImage, IINormalFunctor&gt; IINormalEstimator;</div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;      <span class="keywordtype">double</span> r = vm[<span class="stringliteral">&quot;r-radius&quot;</span>].as&lt;<span class="keywordtype">double</span>&gt;();</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;      <span class="keywordtype">double</span> alpha = vm[<span class="stringliteral">&quot;alpha&quot;</span>].as&lt;<span class="keywordtype">double</span>&gt;();</div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;      <span class="keywordflow">if</span> ( alpha != 0.0 ) r *= pow( h, alpha-1.0 );</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;      trace.info() &lt;&lt; <span class="stringliteral">&quot; r=&quot;</span> &lt;&lt; r &lt;&lt; std::endl;</div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;      trace.beginBlock( <span class="stringliteral">&quot;Preparing characteristic set.&quot;</span> );</div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;      Domain domain( K.lowerBound(), K.upperBound() );</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;      Image image( domain );</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;      <span class="keywordflow">for</span> ( DomainConstIterator it = domain.begin(), itE = domain.end(); it != itE; ++it )</div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;        {</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;          image.setValue( *it, ptPred( *it ) );</div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;        }</div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;      trace.endBlock();</div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;      trace.beginBlock( <span class="stringliteral">&quot;Initialize II estimator.&quot;</span> );</div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;      ThresholdedImage thresholdedImage( image, <span class="keyword">false</span> );</div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;      IINormalEstimator ii_estimator( K, thresholdedImage );</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;      ii_estimator.setParams( r );</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;      ii_estimator.init( h, surface.begin(), surface.end() );</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;      trace.endBlock();</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;      trace.endBlock();</div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;      computeEstimation( vm, K, shape, surface, true_estimator, ii_estimator );</div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;   }</div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;</div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;}</div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;<span class="keyword">template</span> &lt;<span class="keyword">typename</span> KSpace,</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;          <span class="keyword">typename</span> ImplicitShape,</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;          <span class="keyword">typename</span> Surface,</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;          <span class="keyword">typename</span> PointPredicate&gt;</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;<span class="keywordtype">void</span> chooseKernel</div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;( <span class="keyword">const</span> po::variables_map&amp; vm,     <span class="comment">//&lt; command-line parameters</span></div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;  <span class="keyword">const</span> KSpace&amp; K,                 <span class="comment">//&lt; cellular grid space</span></div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;  <span class="keyword">const</span> ImplicitShape&amp; shape,      <span class="comment">//&lt; implicit shape &quot;ground truth&quot;</span></div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;  <span class="keyword">const</span> Surface&amp; surface,          <span class="comment">//&lt; digital surface approximating shape</span></div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;  <span class="keyword">const</span> PointPredicate&amp; ptPred )   <span class="comment">//&lt; analysed implicit digital shape as a PointPredicate</span></div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;{</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;  <span class="keywordtype">string</span> kernel = vm[ <span class="stringliteral">&quot;kernel&quot;</span> ].as&lt;<span class="keywordtype">string</span>&gt;();</div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;  <span class="keywordtype">double</span> h = vm[<span class="stringliteral">&quot;gridstep&quot;</span>].as&lt;<span class="keywordtype">double</span>&gt;();</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;  <span class="keywordtype">double</span> r = vm[<span class="stringliteral">&quot;r-radius&quot;</span>].as&lt;<span class="keywordtype">double</span>&gt;();</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;  <span class="keywordtype">double</span> alpha = vm[<span class="stringliteral">&quot;alpha&quot;</span>].as&lt;<span class="keywordtype">double</span>&gt;();</div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;  <span class="keywordflow">if</span> ( alpha != 0.0 ) r *= pow( h, alpha-1.0 );</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;  <span class="keywordflow">if</span> ( kernel == <span class="stringliteral">&quot;hat&quot;</span> ) {</div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;    <span class="keyword">typedef</span> <span class="keyword">typename</span> KSpace::Point Point;</div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;    <span class="keyword">typedef</span> functors::HatPointFunction&lt;Point,double&gt; KernelFunction;</div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;    KernelFunction chi_r( 1.0, r );</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;    chooseEstimator( vm, K, shape, surface, chi_r, ptPred );</div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( kernel == <span class="stringliteral">&quot;ball&quot;</span> ) {</div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;    <span class="keyword">typedef</span> <span class="keyword">typename</span> KSpace::Point Point;</div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;    <span class="keyword">typedef</span> functors::BallConstantPointFunction&lt;Point,double&gt; KernelFunction;</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;    KernelFunction chi_r( 1.0, r );</div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;    chooseEstimator( vm, K, shape, surface, chi_r, ptPred );</div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;  }</div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;}</div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;</div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;<span class="keyword">template</span> &lt;<span class="keyword">typename</span> KSpace,</div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;          <span class="keyword">typename</span> ImplicitShape,</div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;          <span class="keyword">typename</span> ImplicitDigitalShape &gt;</div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;<span class="keywordtype">int</span> chooseSurface</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;( <span class="keyword">const</span> po::variables_map&amp; vm,     <span class="comment">//&lt; command-line parameters</span></div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;  <span class="keyword">const</span> KSpace&amp; K,                 <span class="comment">//&lt; cellular grid space</span></div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;  <span class="keyword">const</span> ImplicitShape&amp; shape,      <span class="comment">//&lt; implicit shape &quot;ground truth&quot;</span></div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;  <span class="keyword">const</span> ImplicitDigitalShape&amp; dshape ) <span class="comment">//&lt; analysed implicit digital shape</span></div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;{</div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;  <span class="comment">// Selecting a model of surface depending on noise / not noise.</span></div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;  <span class="keyword">typedef</span> <span class="keywordtype">double</span> Scalar;</div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;  Scalar noiseLevel = vm[ <span class="stringliteral">&quot;noise&quot;</span> ].as&lt;<span class="keywordtype">double</span>&gt;();</div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;  <span class="keywordflow">if</span> ( noiseLevel == 0.0 )</div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;    { <span class="comment">// no noise</span></div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;      trace.beginBlock( <span class="stringliteral">&quot;Make digital surface...&quot;</span> );</div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;      <span class="keyword">typedef</span> LightImplicitDigitalSurface&lt;KSpace,ImplicitDigitalShape&gt; SurfaceContainer;</div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;      <span class="keyword">typedef</span> DigitalSurface&lt; SurfaceContainer &gt; Surface;</div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;      <span class="keyword">typedef</span> <span class="keyword">typename</span> Surface::Surfel Surfel;</div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;      SurfelAdjacency&lt; KSpace::dimension &gt; surfAdj( <span class="keyword">true</span> );</div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;      Surfel bel;</div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;      <span class="keywordflow">try</span> {</div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;        bel = Surfaces&lt;KSpace&gt;::findABel( K, dshape, 10000 );</div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;      } <span class="keywordflow">catch</span> (DGtal::InputException e) {</div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;        trace.error() &lt;&lt; <span class="stringliteral">&quot;ERROR Unable to find bel.&quot;</span> &lt;&lt; std::endl;</div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;        <span class="keywordflow">return</span> 3;</div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;      }</div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;      SurfaceContainer* surfaceContainer = <span class="keyword">new</span> SurfaceContainer( K, dshape, surfAdj, bel );</div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;      CountedPtr&lt;Surface&gt; ptrSurface( <span class="keyword">new</span> Surface( surfaceContainer ) ); <span class="comment">// acquired</span></div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;      trace.info() &lt;&lt; <span class="stringliteral">&quot;- surface component has &quot;</span> &lt;&lt; ptrSurface-&gt;size() &lt;&lt; <span class="stringliteral">&quot; surfels.&quot;</span> &lt;&lt; std::endl;</div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;      trace.endBlock();</div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;      chooseKernel( vm, K, shape, *ptrSurface, dshape );</div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;    }</div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;    { <span class="comment">// noise</span></div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;      trace.beginBlock( <span class="stringliteral">&quot;Make digital surface...&quot;</span> );</div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;      <span class="keyword">typedef</span> <span class="keyword">typename</span> ImplicitDigitalShape::Domain Domain;</div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;      <span class="keyword">typedef</span> KanungoNoise&lt; ImplicitDigitalShape, Domain &gt; KanungoPredicate;</div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;      <span class="keyword">typedef</span> LightImplicitDigitalSurface&lt; KSpace, KanungoPredicate &gt; SurfaceContainer;</div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;      <span class="keyword">typedef</span> DigitalSurface&lt; SurfaceContainer &gt; Surface;</div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;      <span class="keyword">typedef</span> <span class="keyword">typename</span> Surface::Surfel Surfel;</div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;      SurfelAdjacency&lt; KSpace::dimension &gt; surfAdj( <span class="keyword">true</span> );</div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;      Surfel bel;</div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;      <span class="keyword">const</span> Domain shapeDomain = dshape.getDomain();</div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;      KanungoPredicate* noisified_dshape = <span class="keyword">new</span> KanungoPredicate( dshape, shapeDomain, noiseLevel );</div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;      <span class="comment">// We have to search for a big connected component.</span></div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;      CountedPtr&lt;Surface&gt; ptrSurface;</div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;      <span class="keywordtype">double</span> minsize = dshape.getUpperBound()[0] - dshape.getLowerBound()[0];</div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;      <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nb_surfels = 0;</div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;      <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> tries = 0;</div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;      <span class="keywordflow">do</span> {</div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;        <span class="keywordflow">try</span> { <span class="comment">// Search initial bel</span></div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;          bel = Surfaces&lt;KSpace&gt;::findABel( K, *noisified_dshape, 10000 );</div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;        } <span class="keywordflow">catch</span> (DGtal::InputException e) {</div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;          trace.error() &lt;&lt; <span class="stringliteral">&quot;ERROR Unable to find bel.&quot;</span> &lt;&lt; std::endl;</div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;          <span class="keywordflow">return</span> 3;</div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;        }</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;        SurfaceContainer* surfaceContainer = <span class="keyword">new</span> SurfaceContainer( K, *noisified_dshape, surfAdj, bel );</div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;        ptrSurface = CountedPtr&lt;Surface&gt;( <span class="keyword">new</span> Surface( surfaceContainer ) ); <span class="comment">// acquired</span></div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;        nb_surfels = ptrSurface-&gt;size();</div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;      } <span class="keywordflow">while</span> ( ( nb_surfels &lt; 2 * minsize ) &amp;&amp; ( tries++ &lt; 150 ) );</div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;      <span class="keywordflow">if</span>( tries &gt;= 150 )</div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;        {</div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;          trace.error() &lt;&lt; <span class="stringliteral">&quot;ERROR cannot find a proper bel in a big enough component.&quot;</span> &lt;&lt; std::endl;</div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;          <span class="keywordflow">return</span> 4;</div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;        }</div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;      trace.info() &lt;&lt; <span class="stringliteral">&quot;- surface component has &quot;</span> &lt;&lt; nb_surfels &lt;&lt; <span class="stringliteral">&quot; surfels.&quot;</span> &lt;&lt; std::endl;</div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;      trace.endBlock();</div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;      chooseKernel( vm, K, shape, *ptrSurface, *noisified_dshape );</div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;    }</div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;  <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;}</div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;</div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;</div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;<span class="keywordtype">int</span> main( <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv )</div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;{</div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;  <span class="comment">// parse command line ----------------------------------------------</span></div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;  <span class="keyword">namespace </span>po = boost::program_options;</div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;  po::options_description general_opt(<span class="stringliteral">&quot;Allowed options are: &quot;</span>);</div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;  general_opt.add_options()</div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;    (<span class="stringliteral">&quot;help,h&quot;</span>, <span class="stringliteral">&quot;display this message&quot;</span>)</div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;    (<span class="stringliteral">&quot;polynomial,p&quot;</span>, po::value&lt;string&gt;(), <span class="stringliteral">&quot;the implicit polynomial whose zero-level defines the shape of interest.&quot;</span> )</div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;    (<span class="stringliteral">&quot;noise,N&quot;</span>, po::value&lt;double&gt;()-&gt;default_value( 0.0 ), <span class="stringliteral">&quot;the Kanungo noise level l=arg, with l^d the probability that a point at distance d is flipped inside/outside.&quot;</span> )</div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;    (<span class="stringliteral">&quot;minAABB,a&quot;</span>,  po::value&lt;double&gt;()-&gt;default_value( -10.0 ), <span class="stringliteral">&quot;the min value of the AABB bounding box (domain)&quot;</span> )</div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;    (<span class="stringliteral">&quot;maxAABB,A&quot;</span>,  po::value&lt;double&gt;()-&gt;default_value( 10.0 ), <span class="stringliteral">&quot;the max value of the AABB bounding box (domain)&quot;</span> )</div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;    (<span class="stringliteral">&quot;gridstep,g&quot;</span>, po::value&lt; double &gt;()-&gt;default_value( 1.0 ), <span class="stringliteral">&quot;the gridstep that defines the digitization (often called h). &quot;</span> )</div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;    (<span class="stringliteral">&quot;estimator,e&quot;</span>, po::value&lt;string&gt;()-&gt;default_value( <span class="stringliteral">&quot;True&quot;</span> ), <span class="stringliteral">&quot;the chosen normal estimator: True | VCM | II | Trivial&quot;</span> )</div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;    (<span class="stringliteral">&quot;R-radius,R&quot;</span>, po::value&lt;double&gt;()-&gt;default_value( 5 ), <span class="stringliteral">&quot;the constant for parameter R in R(h)=R h^alpha (VCM).&quot;</span> )</div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;    (<span class="stringliteral">&quot;r-radius,r&quot;</span>, po::value&lt;double&gt;()-&gt;default_value( 3 ), <span class="stringliteral">&quot;the constant for parameter r in r(h)=r h^alpha (VCM,II,Trivial).&quot;</span> )</div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;    (<span class="stringliteral">&quot;kernel,k&quot;</span>, po::value&lt;string&gt;()-&gt;default_value( <span class="stringliteral">&quot;hat&quot;</span> ), <span class="stringliteral">&quot;the function chi_r, either hat or ball.&quot;</span> )</div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;    (<span class="stringliteral">&quot;alpha&quot;</span>, po::value&lt;double&gt;()-&gt;default_value( 0.0 ), <span class="stringliteral">&quot;the parameter alpha in r(h)=r h^alpha (VCM).&quot;</span> )</div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;    (<span class="stringliteral">&quot;trivial-radius,t&quot;</span>, po::value&lt;double&gt;()-&gt;default_value( 3 ), <span class="stringliteral">&quot;the parameter t defining the radius for the Trivial estimator. Also used for reorienting the VCM.&quot;</span> )</div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;    (<span class="stringliteral">&quot;embedding,E&quot;</span>, po::value&lt;int&gt;()-&gt;default_value( 0 ), <span class="stringliteral">&quot;the surfel -&gt; point embedding for VCM estimator: 0: Pointels, 1: InnerSpel, 2: OuterSpel.&quot;</span> )</div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;    (<span class="stringliteral">&quot;output,o&quot;</span>, po::value&lt;string&gt;()-&gt;default_value( <span class="stringliteral">&quot;output&quot;</span> ), <span class="stringliteral">&quot;the output basename. All generated files will have the form &lt;arg&gt;-*, for instance &lt;arg&gt;-angle-deviation-&lt;gridstep&gt;.txt, &lt;arg&gt;-normals-&lt;gridstep&gt;.txt, &lt;arg&gt;-cells-&lt;gridstep&gt;.txt, &lt;arg&gt;-noff-&lt;gridstep&gt;.off.&quot;</span> )</div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;    (<span class="stringliteral">&quot;angle-deviation-stats,S&quot;</span>, <span class="stringliteral">&quot;computes angle deviation error and outputs them in file &lt;basename&gt;-angle-deviation-&lt;gridstep&gt;.txt, as specified by -o &lt;basename&gt;.&quot;</span> )</div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;    (<span class="stringliteral">&quot;export,x&quot;</span>, po::value&lt;string&gt;()-&gt;default_value( <span class="stringliteral">&quot;None&quot;</span> ), <span class="stringliteral">&quot;exports surfel normals which can be viewed with ImaGene tool &#39;viewSetOfSurfels&#39; in file &lt;basename&gt;-cells-&lt;gridstep&gt;.txt, as specified by -o &lt;basename&gt;. Parameter &lt;arg&gt; is None|Normals|AngleDeviation. The color depends on the angle deviation in degree: 0 metallic blue, 5 light cyan, 10 light green, 15 light yellow, 20 yellow, 25 orange, 30 red, 35, dark red, 40- grey&quot;</span> )</div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;    (<span class="stringliteral">&quot;normals,n&quot;</span>, <span class="stringliteral">&quot;outputs every surfel, its estimated normal, and the ground truth normal in file &lt;basename&gt;-normals-&lt;gridstep&gt;.txt, as specified by -o &lt;basename&gt;.&quot;</span> )</div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;    (<span class="stringliteral">&quot;noff,O&quot;</span>,<span class="stringliteral">&quot;exports the digital surface with normals as NOFF file &lt;basename&gt;-noff-&lt;gridstep&gt;.off, as specified by -o &lt;basename&gt;..&quot;</span> )</div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;#ifdef WITH_VISU3D_QGLVIEWER</div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;    (<span class="stringliteral">&quot;view,V&quot;</span>, po::value&lt;string&gt;()-&gt;default_value( <span class="stringliteral">&quot;None&quot;</span> ),<span class="stringliteral">&quot;view the digital surface with normals.  Parameter &lt;arg&gt; is None|Normals|AngleDeviation. The color depends on the angle deviation in degree: 0 metallic blue, 5 light cyan, 10 light green, 15 light yellow, 20 yellow, 25 orange, 30 red, 35, dark red, 40- grey.&quot;</span> )</div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;#endif</div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;    ;</div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;  <span class="keywordtype">bool</span> parseOK=<span class="keyword">true</span>;</div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;  po::variables_map vm;</div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;  <span class="keywordflow">try</span>{</div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;    po::store(po::parse_command_line(argc, argv, general_opt), vm);</div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;  }<span class="keywordflow">catch</span>(<span class="keyword">const</span> exception&amp; ex){</div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;    parseOK=<span class="keyword">false</span>;</div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;    cerr &lt;&lt; <span class="stringliteral">&quot;Error checking program options: &quot;</span>&lt;&lt; ex.what()&lt;&lt; endl;</div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;  }</div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;  po::notify(vm);</div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;  <span class="keywordflow">if</span>( ! parseOK || vm.count(<span class="stringliteral">&quot;help&quot;</span>) || ! vm.count( <span class="stringliteral">&quot;polynomial&quot;</span> ) )</div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;    {</div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;      <span class="keywordflow">if</span> ( ! vm.count( <span class="stringliteral">&quot;polynomial&quot;</span> ) )</div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;        cerr &lt;&lt; <span class="stringliteral">&quot;Need parameter --polynomial / -p&quot;</span> &lt;&lt; endl;</div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;</div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;      cerr &lt;&lt; <span class="stringliteral">&quot;Usage: &quot;</span> &lt;&lt; argv[0] &lt;&lt; <span class="stringliteral">&quot; -p &lt;polynomial&gt; [options]\n&quot;</span></div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;    &lt;&lt; <span class="stringliteral">&quot;Computes a normal vector field over a digitized 3D implicit surface for several estimators (II|VCM|Trivial|True), specified with -e. You may add Kanungo noise with option -N. These estimators are compared with ground truth. You may then: 1) visualize the normals or the angle deviations with -V (if WITH_QGL_VIEWER is enabled), 2) outputs them as a list of cells/estimations with -n, 3) outputs them as a ImaGene file with -O, 4) outputs them as a NOFF file with -O, 5) computes estimation statistics with option -S.&quot;</span></div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;                &lt;&lt; endl</div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;    &lt;&lt; general_opt &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;      cerr &lt;&lt; <span class="stringliteral">&quot;Example of use:\n&quot;</span></div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;           &lt;&lt; <span class="stringliteral">&quot;./generic3dNormalEstimator -p \&quot;90-3*x^2-2*y^2-z^2\&quot; -o VCM-ellipse -a -10 -A 10 -e VCM -R 3 -r 3 -t 2 -E 0 -x Normals&quot;</span> &lt;&lt; endl &lt;&lt; endl</div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;           &lt;&lt; <span class="stringliteral">&quot;Example of implicit surfaces (specified by -p):&quot;</span> &lt;&lt; endl</div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;           &lt;&lt; <span class="stringliteral">&quot; - ellipse  : 90-3*x^2-2*y^2-z^2 &quot;</span> &lt;&lt; endl</div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;           &lt;&lt; <span class="stringliteral">&quot; - torus    : -1*(x^2+y^2+z^2+6*6-2*2)^2+4*6*6*(x^2+y^2) &quot;</span> &lt;&lt; endl</div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;           &lt;&lt; <span class="stringliteral">&quot; - rcube    : 6561-x^4-y^4-z^4&quot;</span> &lt;&lt; endl</div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;           &lt;&lt; <span class="stringliteral">&quot; - goursat  : 8-0.03*x^4-0.03*y^4-0.03*z^4+2*x^2+2*y^2+2*z^2&quot;</span> &lt;&lt; endl</div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;           &lt;&lt; <span class="stringliteral">&quot; - distel   : 10000-(x^2+y^2+z^2+1000*(x^2+y^2)*(x^2+z^2)*(y^2+z^2))&quot;</span> &lt;&lt; endl</div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;           &lt;&lt; <span class="stringliteral">&quot; - leopold  : 100-(x^2*y^2*z^2+4*x^2+4*y^2+3*z^2)&quot;</span> &lt;&lt; endl</div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;           &lt;&lt; <span class="stringliteral">&quot; - diabolo  : x^2-(y^2+z^2)^2&quot;</span> &lt;&lt; endl</div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;           &lt;&lt; <span class="stringliteral">&quot; - heart    : -1*(x^2+2.25*y^2+z^2-1)^3+x^2*z^3+0.1125*y^2*z^3&quot;</span> &lt;&lt; endl</div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;           &lt;&lt; <span class="stringliteral">&quot; - crixxi   : -0.9*(y^2+z^2-1)^2-(x^2+y^2-1)^3&quot;</span> &lt;&lt; endl &lt;&lt; endl;</div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;      cerr &lt;&lt; <span class="stringliteral">&quot;Implemented estimators (specified by -e):&quot;</span> &lt;&lt; endl</div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;           &lt;&lt; <span class="stringliteral">&quot; - True     : supposed to be the ground truth for computations. Of course, it is only approximations.&quot;</span> &lt;&lt; endl</div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;           &lt;&lt; <span class="stringliteral">&quot; - VCM      : normal estimator by digital Voronoi Covariance Matrix. Radii parameters are given by -R, -r.&quot;</span> &lt;&lt; endl</div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;           &lt;&lt; <span class="stringliteral">&quot; - II       : normal estimator by Integral Invariants. Radius parameter is given by -r.&quot;</span> &lt;&lt; endl</div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;           &lt;&lt; <span class="stringliteral">&quot; - Trivial  : the normal obtained by average trivial surfel normals in a ball neighborhood. Radius parameter is given by -r.&quot;</span> &lt;&lt; endl</div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;           &lt;&lt; endl;</div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;      cerr &lt;&lt; <span class="stringliteral">&quot;Note:&quot;</span> &lt;&lt; endl</div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;           &lt;&lt; <span class="stringliteral">&quot;     - This is a normal *direction* evaluator more than a normal vector evaluator. Orientations of normals are deduced from ground truth. This is due to the fact that II and VCM only estimates normal directions.&quot;</span> &lt;&lt; endl</div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;           &lt;&lt; <span class="stringliteral">&quot;     - This tool only analyses one surface component, and one that contains at least as many surfels as the width of the digital bounding box. This is required when analysing noisy data, where a lot of the small components are spurious. The drawback is that you cannot analyse the normals on a surface with several components.&quot;</span> &lt;&lt; endl;</div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;      <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;    }</div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;</div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;  trace.beginBlock( <span class="stringliteral">&quot;Make implicit shape...&quot;</span> );</div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;  <span class="keyword">typedef</span> Z3i::Space Space;</div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;  <span class="keyword">typedef</span> <span class="keywordtype">double</span> Scalar;</div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;  <span class="keyword">typedef</span> MPolynomial&lt; 3, Scalar &gt; Polynomial3;</div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;  <span class="keyword">typedef</span> MPolynomialReader&lt;3, Scalar&gt; Polynomial3Reader;</div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;  <span class="keyword">typedef</span> ImplicitPolynomial3Shape&lt;Space&gt; ImplicitShape;</div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;  <span class="keywordtype">string</span> poly_str = vm[ <span class="stringliteral">&quot;polynomial&quot;</span> ].as&lt;<span class="keywordtype">string</span>&gt;();</div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;  Polynomial3 poly;</div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;  Polynomial3Reader reader;</div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;  string::const_iterator iter = reader.read( poly, poly_str.begin(), poly_str.end() );</div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;  <span class="keywordflow">if</span> ( iter != poly_str.end() )</div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;    {</div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;      trace.error() &lt;&lt; <span class="stringliteral">&quot;ERROR reading polynomial: I read only &lt;&quot;</span> &lt;&lt; poly_str.substr( 0, iter - poly_str.begin() )</div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;                    &lt;&lt; <span class="stringliteral">&quot;&gt;, and I built P=&quot;</span> &lt;&lt; poly &lt;&lt; std::endl;</div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;      <span class="keywordflow">return</span> 2;</div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;    }</div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;  CountedPtr&lt;ImplicitShape&gt; shape( <span class="keyword">new</span> ImplicitShape( poly ) ); <span class="comment">// smart pointer</span></div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;  trace.endBlock();</div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;</div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;  trace.beginBlock( <span class="stringliteral">&quot;Make implicit digital shape...&quot;</span> );</div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;  <span class="keyword">typedef</span> Z3i::KSpace KSpace;</div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;  <span class="keyword">typedef</span> KSpace::Point Point;</div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;  <span class="keyword">typedef</span> Space::RealPoint RealPoint;</div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;  <span class="keyword">typedef</span> GaussDigitizer&lt; Space, ImplicitShape &gt; ImplicitDigitalShape;</div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;  <span class="keyword">typedef</span> ImplicitDigitalShape::Domain Domain;</div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;  Scalar min_x = vm[ <span class="stringliteral">&quot;minAABB&quot;</span> ].as&lt;<span class="keywordtype">double</span>&gt;();</div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;  Scalar max_x = vm[ <span class="stringliteral">&quot;maxAABB&quot;</span> ].as&lt;<span class="keywordtype">double</span>&gt;();</div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;  Scalar h = vm[ <span class="stringliteral">&quot;gridstep&quot;</span> ].as&lt;<span class="keywordtype">double</span>&gt;();</div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;  RealPoint p1( min_x, min_x, min_x );</div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;  RealPoint p2( max_x, max_x, max_x );</div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;  CountedPtr&lt;ImplicitDigitalShape&gt; dshape( <span class="keyword">new</span> ImplicitDigitalShape() );</div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;  dshape-&gt;attach( *shape );</div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;  dshape-&gt;init( p1, p2, h );</div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;  Domain domain = dshape-&gt;getDomain();</div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;  KSpace K;</div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;  K.init( domain.lowerBound(), domain.upperBound(), true );</div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;  trace.info() &lt;&lt; <span class="stringliteral">&quot;- domain is &quot;</span> &lt;&lt; domain &lt;&lt; std::endl;</div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;  trace.endBlock();</div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;</div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;  chooseSurface( vm, K, *shape, *dshape );</div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;</div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;  <span class="keywordflow">return</span> 0;</div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;}</div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;</div><div class="ttc" id="namespacestd_html"><div class="ttname"><a href="namespacestd.html">std</a></div><div class="ttdoc">STL namespace. </div></div>
<div class="ttc" id="namespaceDGtal_html"><div class="ttname"><a href="namespaceDGtal.html">DGtal</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.11-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Companion project associated to  <a href= "http://liris.cnrs.fr/dgtal/doc/nightly/"> DGtal </a>;
    Generated on Mon Jun 27 2016 12:21:49 for DGtalTools by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
